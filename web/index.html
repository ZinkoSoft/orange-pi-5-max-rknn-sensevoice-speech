<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live NPU Transcription</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
            padding: 20px 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }
        
        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .status {
            padding: 20px 30px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #dc3545;
            animation: pulse 2s infinite;
        }
        
        .status-dot.connected {
            background: #28a745;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .controls {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0056b3;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #545b62;
        }
        
        .transcription-area {
            padding: 30px;
            min-height: 400px;
        }
        
        .transcription-item {
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .confidence-high {
            background: #d4edda;
            border-color: #28a745;
        }
        
        .confidence-medium {
            background: #fff3cd;
            border-color: #ffc107;
        }
        
        .confidence-low {
            background: #f8d7da;
            border-color: #dc3545;
        }
        
        .transcription-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.9em;
            opacity: 0.8;
        }
        
        .transcription-text {
            font-size: 1.2em;
            line-height: 1.4;
            margin: 0;
        }
        
        .timestamp {
            font-family: monospace;
            color: #666;
        }
        
        .confidence-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .confidence-badge.high {
            background: #28a745;
            color: white;
        }
        
        .confidence-badge.medium {
            background: #ffc107;
            color: #212529;
        }
        
        .confidence-badge.low {
            background: #dc3545;
            color: white;
        }
        
        .metadata-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 500;
            background: #e9ecef;
            color: #495057;
            margin-right: 4px;
        }
        
        .empty-state {
            text-align: center;
            color: #6c757d;
            padding: 60px 20px;
            font-size: 1.1em;
        }
        
        .stats {
            padding: 20px 30px;
            background: #f8f9fa;
            border-top: 1px solid #eee;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #6c757d;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎤 Live NPU Transcription</h1>
            <p>Real-time speech recognition powered by Orange Pi 5 Max NPU</p>
        </div>
        
        <div class="status">
            <div class="status-indicator">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">Disconnected</span>
            </div>
            <div class="controls">
                <button class="btn btn-primary" id="connectBtn" onclick="connect()">Connect</button>
                <button class="btn btn-secondary" id="clearBtn" onclick="clearTranscriptions()">Clear</button>
            </div>
        </div>
        
        <div class="transcription-area" id="transcriptionArea">
            <div class="empty-state">
                <p>🎯 Connect to WebSocket to start receiving live transcriptions</p>
                <p><small>Make sure the NPU transcription service is running</small></p>
            </div>
        </div>
        
        <div class="stats">
            <div class="stat-item">
                <div class="stat-value" id="totalMessages">0</div>
                <div class="stat-label">Total Messages</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="highConfidence">0</div>
                <div class="stat-label">High Confidence</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="connectionTime">0s</div>
                <div class="stat-label">Connected Time</div>
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        let isConnected = false;
        let stats = {
            totalMessages: 0,
            highConfidence: 0,
            connectionStartTime: null
        };
        
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const connectBtn = document.getElementById('connectBtn');
        const transcriptionArea = document.getElementById('transcriptionArea');
        
        function updateStatus(connected) {
            isConnected = connected;
            statusDot.classList.toggle('connected', connected);
            statusText.textContent = connected ? 'Connected' : 'Disconnected';
            connectBtn.textContent = connected ? 'Disconnect' : 'Connect';
            connectBtn.className = connected ? 'btn btn-secondary' : 'btn btn-primary';
            
            if (connected) {
                stats.connectionStartTime = Date.now();
                startConnectionTimer();
            } else {
                stats.connectionStartTime = null;
            }
        }
        
        function startConnectionTimer() {
            if (!stats.connectionStartTime) return;
            
            const updateTimer = () => {
                if (stats.connectionStartTime && isConnected) {
                    const elapsed = Math.floor((Date.now() - stats.connectionStartTime) / 1000);
                    document.getElementById('connectionTime').textContent = elapsed + 's';
                    setTimeout(updateTimer, 1000);
                }
            };
            updateTimer();
        }
        
        function connect() {
            if (isConnected) {
                disconnect();
                return;
            }
            
            const wsUrl = `ws://${window.location.hostname}:8765`;
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function(event) {
                console.log('WebSocket connected');
                updateStatus(true);
                clearEmptyState();
            };
            
            ws.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    addTranscription(data);
                    updateStats();
                } catch (error) {
                    console.error('Error parsing message:', error);
                }
            };
            
            ws.onclose = function(event) {
                console.log('WebSocket disconnected');
                updateStatus(false);
            };
            
            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
                updateStatus(false);
            };
        }
        
        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
            updateStatus(false);
        }
        
        function clearEmptyState() {
            const emptyState = transcriptionArea.querySelector('.empty-state');
            if (emptyState) {
                emptyState.remove();
            }
        }
        
        function addTranscription(data) {
            clearEmptyState();
            
            const item = document.createElement('div');
            item.className = `transcription-item confidence-${data.confidence.toLowerCase()}`;
            
            const timestamp = new Date(data.timestamp).toLocaleTimeString();
            
            // Build metadata badges
            let metadataBadges = '';
            if (data.language) {
                metadataBadges += `<span class="metadata-badge">${data.language.toUpperCase()}</span>`;
            }
            if (data.emotion) {
                const emotionEmoji = getEmotionEmoji(data.emotion);
                metadataBadges += `<span class="metadata-badge">${emotionEmoji} ${data.emotion}</span>`;
            }
            if (data.audio_events && data.audio_events.length > 0) {
                data.audio_events.forEach(event => {
                    const eventEmoji = getEventEmoji(event);
                    metadataBadges += `<span class="metadata-badge">${eventEmoji} ${event}</span>`;
                });
            }
            
            item.innerHTML = `
                <div class="transcription-header">
                    <span class="timestamp">${timestamp}</span>
                    <div style="display: flex; gap: 5px; align-items: center;">
                        ${metadataBadges}
                        <span class="confidence-badge ${data.confidence.toLowerCase()}">${data.confidence}</span>
                    </div>
                </div>
                <p class="transcription-text">${escapeHtml(data.text)}</p>
            `;
            
            transcriptionArea.appendChild(item);
            
            // Auto-scroll to bottom
            transcriptionArea.scrollTop = transcriptionArea.scrollHeight;
            
            // Update stats
            stats.totalMessages++;
            if (data.confidence === 'HIGH') {
                stats.highConfidence++;
            }
        }
        
        function getEmotionEmoji(emotion) {
            const emojis = {
                'HAPPY': '😊',
                'SAD': '😢',
                'ANGRY': '😠',
                'NEUTRAL': '😐',
                'UNKNOWN': '🤔'
            };
            return emojis[emotion] || '😐';
        }
        
        function getEventEmoji(event) {
            const emojis = {
                'BGM': '🎵',
                'Speech': '🗣️',
                'Applause': '👏',
                'Laughter': '😂'
            };
            return emojis[event] || '🔊';
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function updateStats() {
            document.getElementById('totalMessages').textContent = stats.totalMessages;
            document.getElementById('highConfidence').textContent = stats.highConfidence;
        }
        
        function clearTranscriptions() {
            transcriptionArea.innerHTML = `
                <div class="empty-state">
                    <p>📝 Transcriptions cleared</p>
                    <p><small>New transcriptions will appear here</small></p>
                </div>
            `;
            
            stats.totalMessages = 0;
            stats.highConfidence = 0;
            updateStats();
        }
        
        // Auto-connect on page load
        window.addEventListener('load', function() {
            // Small delay to ensure the page is fully loaded
            setTimeout(connect, 500);
        });
        
        // Handle page unload
        window.addEventListener('beforeunload', function() {
            if (ws) {
                ws.close();
            }
        });
    </script>
</body>
</html>